<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIN ‚Äî My Requests</title>
<link rel="icon" type="image/png" href="image.png?v=1">
<link rel="shortcut icon" href="image.png?v=1">
<style>
  :root{
    --bg:#f7f7fb; --card:#fff; --ink:#0f172a; --muted:#6b7280; --border:#e6e7ec;
    --field:#f2f3f6; --field-text:#111827; --purple:#4f46e5; --danger:#ef4444; --dark:#0c0c14;
    --content-width:1032px; --logo-size:44px; --tab-radius:18px; --tab-pad-y:12px; --tab-pad-x:16px; --tab-min-h:44px; --icon-size:16px;
    --card-radius:22px; --field-radius:14px; --shadow:0 10px 24px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}

  /* Header */
  .header{position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:2}
  .header .row{max-width:calc(var(--content-width) + 88px);margin:auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{height:var(--logo-size);width:var(--logo-size);border-radius:12px;background:var(--purple);color:#fff;display:grid;place-items:center;font-weight:800}
  .brand h1{margin:0;font-size:20px}
  .brand small{display:block;color:#6b7280}

  /* Unified Logout button */
  .btn{
    appearance:none;border:1px solid var(--border);background:#fff;
    padding:10px 14px;border-radius:12px;cursor:pointer;color:#111;text-decoration:none;font-weight:600;
  }
  .btn:hover{background:#f3f4f6}

  /* Tabs (match Search/Create) */
  .wrap{max-width:var(--content-width);margin:auto;padding:24px}
  .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;background:#ececef;border-radius:22px;padding:6px}
  .tabs a{display:flex;align-items:center;justify-content:center;gap:8px;padding:var(--tab-pad-y) var(--tab-pad-x);min-height:var(--tab-min-h);border-radius:var(--tab-radius);color:#111;text-decoration:none;font-weight:600;line-height:1}
  .tabs a svg{width:var(--icon-size);height:var(--icon-size)}
  .tabs a:hover{background:#e9e9f2}
  .tabs a.current{background:var(--purple);color:#fff}
  .space{height:24px}

  /* Card + list */
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--card-radius);box-shadow:var(--shadow);padding:24px}
  .card h2{margin:0 0 4px}
  .lead{color:#8b92a0;margin:0 0 18px}
  .actionsRow{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .primary{background:var(--dark); color:#fff; border:0; padding:12px 16px; border-radius:14px; display:inline-flex; align-items:center; gap:10px; font-weight:700; text-decoration:none}
  .primary:hover{filter:brightness(1.05)}

  .list{display:grid;gap:14px}
  .item{background:#fff;border:1px solid var(--border);border-radius:14px;padding:16px;display:grid;gap:8px;position:relative;cursor:pointer;transition:box-shadow .2s, transform .06s}
  .item:hover{box-shadow:0 6px 18px rgba(2,6,23,.06)}
  .item:active{transform:scale(.998)}
  .titleRow{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .title{font-weight:800}
  .status{font-size:12px;padding:6px 10px;border-radius:999px;font-weight:800}
  .s-inprog{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
  .s-pending{background:#fffbeb;color:#92400e;border:1px solid #fde68a}
  .s-done{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}
  .meta{display:flex;gap:14px;align-items:center;color:#6b7280;font-size:14px}
  .meta .dot::before{content:"‚Ä¢";margin:0 6px;color:#cbd5e1}
  .linkbtn{font-size:13px;padding:12px 16px;border-radius:14px;border:1px solid var(--border);background:#fff;text-decoration:none;color:#111;font-weight:600}
  .linkbtn:hover{background:#f3f4f6}
  .empty{border:1px dashed var(--border);border-radius:14px;padding:20px;text-align:center;color:#8b92a0}

  /* Logout modal */
  #logoutModal::backdrop{ background:rgba(2,6,23,.45) }
  #logoutModal{ border:0; padding:0; border-radius:20px; width:min(440px,92%) }
  #logoutModal .lg-card{
    background:#fff; border:1px solid #e5e7eb; border-radius:20px;
    padding:20px; box-shadow:0 24px 48px rgba(2,6,23,.18);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  #logoutModal h3{ margin:0 0 6px; font-size:20px }
  #logoutModal .lg-text{ margin:0 0 16px; color:#6b7280 }
  #logoutModal .lg-actions{ display:flex; gap:10px; justify-content:flex-end }
  #logoutModal .lg-btn{
    padding:12px 16px; border-radius:14px; border:1px solid #e5e7eb;
    cursor:pointer; background:#fff; font-weight:600;
  }
  #logoutModal .lg-btn.ghost:hover{ background:#f3f4f6 }
  #logoutModal .lg-btn.danger{ background:#0c0c14; color:#fff; border-color:#0c0c14 }
  #logoutModal .lg-btn.danger:hover{ filter:brightness(1.05) }
</style>
</head>
<body>
  <header class="header">
    <div class="row">
      <div class="brand">
        <div class="logo">P</div>
        <div><h1>Person-In-Need Portal</h1><small id="who">Logged in</small></div>
      </div>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Tabs (same as search/create) -->
    <nav class="tabs">
      <a href="view-requests.html" class="current">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5h18M3 12h18M3 19h18"/></svg>
        View Requests
      </a>
      <a href="search-requests.html">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        Search Requests
      </a>
      <a href="create-request.html">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Create Request
      </a>
    </nav>

    <div class="space"></div>

    <section class="card">
      <div class="actionsRow">
        <div>
          <h2 style="margin:0">Your Requests</h2>
          <p class="lead" style="margin:2px 0 0">Requests created by you</p>
        </div>
        <a href="create-request.html" class="primary">+ New request</a>
      </div>

      <div id="results" class="list"></div>
      <div id="empty" class="empty" style="display:none">No requests yet. Create one!</div>
      <div id="error" class="empty" style="display:none;color:#b91c1c;border-color:#fecaca;background:#fff5f5">Failed to load your requests.</div>
    </section>
  </main>

  <!-- Logout modal -->
  <dialog id="logoutModal" aria-labelledby="logoutTitle">
    <div class="lg-card">
      <h3 id="logoutTitle">Log out?</h3>
      <p class="lg-text">You‚Äôll be returned to the role selection page.</p>
      <div class="lg-actions">
        <button type="button" class="lg-btn ghost" id="lgCancel">Cancel</button>
        <button type="button" class="lg-btn danger" id="lgConfirm">Log out</button>
      </div>
    </div>
  </dialog>

<script>
  const $ = (s,r=document)=>r.querySelector(s);

  function statusClass(s){
    s = (s||'').toLowerCase();
    if(s.includes('progress')) return 'status s-inprog';
    if(s.includes('pending'))  return 'status s-pending';
    if(s.includes('complete')) return 'status s-done';
    return 'status';
  }
  const fmtDate = d => d ? new Date(d+'T00:00').toLocaleDateString() : '‚Äî';

  function row(rec){
    const el = document.createElement('article');
    el.className='item';
    el.innerHTML = `
      <div class="titleRow">
        <div class="title">${rec.title || 'Untitled'}</div>
        <span class="${statusClass(rec.status||'Pending')}">${rec.status || 'Pending'}</span>
      </div>
      <div class="meta">
        <span>#${rec.id || '‚Äî'}</span>
        <span class="dot"></span><span>${rec.category || '‚Äî'}</span>
        <span class="dot"></span><span>${fmtDate(rec.date)}</span>
        ${rec.location ? `<span class="dot"></span><span>üìç ${rec.location}</span>` : ''}
      </div>
      <div style="position:absolute;right:12px;bottom:12px;display:flex;gap:8px">
        <a class="linkbtn" href="request-detail.html?id=${encodeURIComponent(rec.id)}" onclick="event.stopPropagation()">View</a>
        <a class="linkbtn" href="update-request.html?id=${encodeURIComponent(rec.id)}" onclick="event.stopPropagation()">Edit</a>
      </div>
    `;
    el.addEventListener('click', ()=> location.href = `request-detail.html?id=${encodeURIComponent(rec.id)}`);
    return el;
  }

  async function loadMine(){
    const res = await fetch('/api/pin/requests', { headers:{'Accept':'application/json'} });
    if(res.status===401 || res.status===403){ location.href='index.html'; return []; }
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    return Array.isArray(data.requests) ? data.requests : [];
  }

  async function render(){
    const results = $('#results');
    const empty = $('#empty');
    const err = $('#error');

    results.innerHTML = '<div class="lead">Loading‚Ä¶</div>';
    empty.style.display='none'; err.style.display='none';

    try{
      // header name
      const w = await fetch('/api/whoami', {headers:{'Accept':'application/json'}});
      if(w.ok){ const me = await w.json(); $('#who').textContent = me?.name ? `Logged in as ${me.name}` : 'Logged in'; }

      const rows = await loadMine();
      results.innerHTML='';
      if(!rows.length){ empty.style.display='block'; return; }
      rows.forEach(r=> results.appendChild(row(r)));
    }catch(e){
      console.error(e);
      results.innerHTML='';
      err.style.display='block';
    }
  }

  // logout (server session)
  async function performLogout(){
    try{ await fetch('/api/logout', {method:'POST', headers:{'Accept':'application/json'}}); }catch(_){}
    location.href = 'index.html';
  }
  (function setupLogout(){
    const trigger = document.getElementById('logoutBtn');
    const dlg = document.getElementById('logoutModal');
    const cancel = document.getElementById('lgCancel');
    const confirm = document.getElementById('lgConfirm');
    if(!trigger || !dlg) return;

    trigger.addEventListener('click', (e)=>{ e.preventDefault(); dlg.showModal(); });
    cancel.addEventListener('click', ()=> dlg.close());
    confirm.addEventListener('click', performLogout);
    dlg.addEventListener('click', (e)=>{
      const r = dlg.getBoundingClientRect();
      const inside = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
      if(!inside) dlg.close();
    });
    dlg.addEventListener('close', ()=> trigger.focus());
  })();

  // mark current tab
  (function(){
    const current = (location.pathname.split('/').pop() || '');
    document.querySelectorAll('.tabs a').forEach(a=>{
      a.classList.toggle('current', a.getAttribute('href')===current);
    });
  })();

  document.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
