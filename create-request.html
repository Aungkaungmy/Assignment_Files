<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIN — Create Request</title>
<link rel="icon" type="image/png" href="image.png?v=1">

<!-- this is create-request.html , but only remove using localStorage not the other -->
<link rel="shortcut icon" href="image.png?v=1">
<style>
  :root{
    --bg:#f7f7fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --border:#e6e7ec;
    --field:#f2f3f6; --field-text:#111827; --purple:#4f46e5; --danger:#ef4444; --dark:#0c0c14;
    --content-width:1032px; --logo-size:44px; --tab-radius:18px; --tab-pad-y:12px; --tab-pad-x:16px; --tab-min-h:44px; --icon-size:16px;
    --card-radius:22px; --field-radius:14px; --shadow:0 10px 24px rgba(2,6,23,.06),0 2px 6px rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:var(--content-width);margin:auto;padding:24px}

  .header{position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:2}
  .header .row{max-width:calc(var(--content-width) + 88px);margin:auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{height:var(--logo-size);width:var(--logo-size);border-radius:12px;background:var(--purple);color:#fff;display:grid;place-items:center;font-weight:800}
  .brand h1{margin:0;font-size:20px}
  .brand small{display:block;color:#6b7280}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:12px 16px;border-radius:14px;cursor:pointer;color:#111;text-decoration:none;font-weight:600}
  .btn:hover{background:#f3f4f6}

  .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;background:#ececef;border-radius:22px;padding:6px}
  .tabs a{display:flex;align-items:center;justify-content:center;gap:8px;padding:var(--tab-pad-y) var(--tab-pad-x);min-height:var(--tab-min-h);border-radius:var(--tab-radius);color:#111;text-decoration:none;font-weight:600;line-height:1}
  .tabs a svg{width:var(--icon-size);height:var(--icon-size)}
  .tabs a:hover{background:#e9e9f2}
  .tabs a.current{background:var(--purple);color:#fff}
  .space{height:24px}

  .card{background:#fff;border:1px solid var(--border);border-radius:var(--card-radius);box-shadow:var(--shadow);padding:24px}
  .muted{color:#6b7280}
  form{display:grid;gap:18px}
  .grid{display:grid;gap:18px}
  @media(min-width:760px){ .two{grid-template-columns:1fr 1fr} }
  label{font-weight:700;color:#2b2f38;margin-bottom:8px;display:block}
  input[type="text"],select,textarea,input[type="date"],input[type="time"]{
    width:100%;border:1px solid #e7e8ee;border-radius:var(--field-radius);padding:12px 14px;background:var(--field);color:var(--field-text);outline:0;box-shadow:inset 0 1px 0 rgba(255,255,255,.6)
  }
  textarea{min-height:120px;resize:vertical}
  input:focus,select:focus,textarea:focus{border-color:#d4d6f7;box-shadow:0 0 0 4px rgba(79,70,229,.12), inset 0 1px 0 rgba(255,255,255,.6)}
  .error{border-color:var(--danger)!important;box-shadow:0 0 0 4px rgba(239,68,68,.12)!important}

  .primary{background:var(--purple);color:#fff;border:0;padding:12px 16px;border-radius:14px;font-weight:800}
  .secondary{border:1px solid var(--border);background:#fff;color:#111;padding:12px 16px;border-radius:14px;text-decoration:none;display:inline-block}

  .hint{display:none;color:var(--danger);font-size:14px;margin-top:6px}
  .hint.show{display:block}

  .success{display:none;margin-top:16px;border:1px dashed var(--border);border-radius:16px;padding:16px}
  .pill{display:inline-block;font-size:12px;padding:6px 10px;border:1px solid #a7f3d0;background:#ecfdf5;color:#065f46;border-radius:999px;font-weight:700}
</style>

<!-- PIN Logout Modal — unified styling -->
<style>
  #logoutModal::backdrop{ background:rgba(2,6,23,.45) }
  #logoutModal{ border:0; padding:0; border-radius:20px; width:min(440px,92%) }
  #logoutModal .lg-card{
    background:#fff; border:1px solid #e5e7eb; border-radius:20px;
    padding:20px; box-shadow:0 24px 48px rgba(2,6,23,.18);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  #logoutModal h3{ margin:0 0 6px; font-size:20px }
  #logoutModal .lg-text{ margin:0 0 16px; color:#6b7280 }
  #logoutModal .lg-actions{ display:flex; gap:10px; justify-content:flex-end }
  #logoutModal .lg-btn{
    padding:12px 16px; border-radius:14px; border:1px solid #e5e7eb;
    cursor:pointer; background:#fff; font-weight:600;
  }
  #logoutModal .lg-btn.ghost:hover{ background:#f3f4f6 }
  #logoutModal .lg-btn.danger{
    background:#0c0c14; color:#fff; border-color:#0c0c14;
  }
  #logoutModal .lg-btn.danger:hover{ filter:brightness(1.05) }
</style>
</head>
<body>
<header class="header">
  <div class="row">
    <div class="brand"><div class="logo">P</div><div><h1>Person-In-Need Portal</h1><small id="who">Logged in</small></div></div>
    <button class="btn" type="button" id="logoutBtn">Logout</button>
  </div>
</header>

<main class="wrap">
  <nav class="tabs">
    <a href="view-requests.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 5h18M3 12h18M3 19h18"/></svg>View Requests
    </a>
    <a href="search-requests.html">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="7"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>Search Requests
    </a>
    <a href="create-request.html" class="current">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Create Request
    </a>
  </nav>
  <div class="space"></div>

  <section class="card">
    <h2 style="margin:0 0 4px">Create a New Request</h2>
    <p class="muted" style="margin:0 0 12px">Provide details for the support you need. CSR reps will match you with volunteers.</p>

    <form id="form" novalidate>
      <div>
        <label for="title">Service Title</label>
        <input id="title" type="text" placeholder="e.g., Transport to Doctor's Appointment" required>
        <div id="h_title" class="hint">Please enter a short title.</div>
      </div>

      <div>
        <label for="category">Service Category</label>
        <select id="category" required>
          <option value="">Select a category</option>
          <option>Transportation</option><option>Home Repair</option><option>Medical Appointment</option>
          <option>Grocery Assistance</option><option>Medical Equipment</option><option>Companionship</option>
          <option>Shopping/Errands</option><option>Meal Delivery</option><option>Other</option>
        </select>
        <div id="h_category" class="hint">Please select a category.</div>
      </div>

      <div>
        <label for="description">Description</label>
        <textarea id="description" placeholder="Briefly describe what you need help with. Include important details."></textarea>
        <div id="h_description" class="hint">Please describe your request.</div>
      </div>

      <div>
        <label for="location">Location</label>
        <input id="location" type="text" placeholder="e.g., 123 ABC Street, #05-01, Singapore">
        <div id="h_location" class="hint">Please provide a location.</div>
      </div>

      <div class="grid two">
        <div>
          <label for="date">Preferred Date</label>
          <input id="date" type="date">
          <div id="h_date" class="hint">Please choose a date.</div>
        </div>
        <div>
          <label for="time">Preferred Time</label>
          <input id="time" type="time">
          <div id="h_time" class="hint">Please choose a time.</div>
        </div>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button type="submit" class="primary">Create Request</button>
        <button type="button" id="resetBtn" class="btn">Reset</button>
      </div>
    </form>

    <div id="success" class="success">
      <div class="pill">Request Created</div>
      <div style="margin-top:10px">
        <div><b>Request ID:</b> <span id="rid">—</span></div>
        <div><b>Category:</b> <span id="rcat">—</span></div>
        <div><b>Date & Time:</b> <span id="rdt">—</span></div>
        <div><b>Location:</b> <span id="rloc">—</span></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <a id="goView" class="btn" href="#">Go to View Requests</a>
        <button id="createAnother" class="btn" type="button">Create Another</button>
      </div>
    </div>
  </section>
</main>

<script>
  // Keep using the global create; server stamps owner to the logged-in PIN automatically:
  const API_CREATE = '/api/requests';

  // body: { title, description, category, date, time, location }
  // (do NOT send owner from client; backend sets it)

  // Tabs: highlight current (no localStorage)
  (function(){
    const current = (location.pathname.split('/').pop() || 'create-request.html');
    document.querySelectorAll('.tabs a').forEach(a => {
      a.classList.toggle('current', a.getAttribute('href') === current);
    });
  })();

  const $=s=>document.querySelector(s);
  const form=$('#form'), success=$('#success');
  const fields=['title','category','description','location','date','time'];
  const els=Object.fromEntries(fields.map(id=>[id,$('#'+id)]));
  const hints=Object.fromEntries(fields.map(id=>[id,$('#h_'+id)]));

  function touch(el){
    const ok = !!el.value.trim();
    el.classList.toggle('error',!ok);
    if(hints[el.id]) hints[el.id].classList.toggle('show',!ok);
    return ok;
  }
  fields.forEach(id=>{
    const el=els[id];
    el.addEventListener('blur',()=>touch(el));
    el.addEventListener('input',()=>touch(el));
  });

  function fmt(dt, tm){ return (dt||'—') + (tm?(' '+tm):''); }

  async function createRequest(payload){
    const res = await fetch('/api/requests', {
      method:'POST',
      headers:{'Content-Type':'application/json','Accept':'application/json'},
      body: JSON.stringify(payload)
    });
    if(!res.ok){
      const msg = await res.text().catch(()=> 'Request failed.');
      throw new Error(msg || ('HTTP '+res.status));
    }
    return res.json();
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    let ok=true; fields.forEach(id=>{ if(!touch(els[id])) ok=false; });
    if(!ok) return;

    const payload={
      title:els.title.value.trim(),
      category:els.category.value,
      description:els.description.value.trim(),
      location:els.location.value.trim(),
      date:els.date.value,
      time:els.time.value
      // owner: (server can infer from session; omit to avoid local storage)
    };

    try{
      const data = await createRequest(payload);
      const rec = (data && data.request) ? data.request : {};
      const rid = rec.id || '—';

      // success UI
      $('#rid').textContent = rid;
      $('#rcat').textContent = rec.category || payload.category || '—';
      $('#rdt').textContent = fmt(rec.date || payload.date, rec.time || payload.time);
      $('#rloc').textContent = rec.location || payload.location || '—';
      success.style.display='block';
      window.scrollTo({top:document.body.scrollHeight, behavior:'smooth'});

      // Go to view & open
      $('#goView').onclick=(ev)=>{ ev.preventDefault(); location.href=`view-requests.html?open=${encodeURIComponent(rid)}`; };
    }catch(err){
      alert('Failed to create request. ' + (err?.message || ''));
    }
  });

  $('#resetBtn').onclick=()=>{
    form.reset();
    fields.forEach(id=>{ els[id].classList.remove('error'); if(hints[id]) hints[id].classList.remove('show'); });
    success.style.display='none';
  };
  $('#createAnother').onclick=()=>{
    form.reset();
    fields.forEach(id=>{ els[id].classList.remove('error'); if(hints[id]) hints[id].classList.remove('show'); });
    success.style.display='none';
    window.scrollTo({top:0, behavior:'smooth'});
  };
</script>

<!-- PIN unified logout modal -->
<dialog id="logoutModal" aria-labelledby="logoutTitle">
  <div class="lg-card">
    <h3 id="logoutTitle">Log out?</h3>
    <p class="lg-text">You’ll be returned to the role selection page.</p>
    <div class="lg-actions">
      <button type="button" class="lg-btn ghost" id="lgCancel">Cancel</button>
      <button type="button" class="lg-btn danger" id="lgConfirm">Log out</button>
    </div>
  </div>
</dialog>

<script>
  // Logout (no localStorage): call server then redirect
  async function performLogout(redirect='index.html'){
    try{ await fetch('/logout', { method:'POST', headers:{'Accept':'application/json'} }); }
    catch(e){}
    location.href = redirect;
  }

  (function setupPinLogout(){
    const trigger = document.getElementById('logoutBtn') || document.querySelector('[data-logout]');
    const dlg = document.getElementById('logoutModal');
    const cancel = document.getElementById('lgCancel');
    const confirm = document.getElementById('lgConfirm');
    if(!trigger || !dlg) return;

    trigger.addEventListener('click', (e)=>{ e.preventDefault(); dlg.showModal(); });
    cancel.addEventListener('click', ()=> dlg.close());
    confirm.addEventListener('click', ()=> performLogout('index.html'));

    dlg.addEventListener('click', (e)=>{
      const r = dlg.getBoundingClientRect();
      const inside = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
      if(!inside) dlg.close();
    });
    dlg.addEventListener('close', ()=> trigger.focus());
  })();
</script>
</body>
</html>
