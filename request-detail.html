<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PIN ‚Äî Request Details</title>
<link rel="icon" type="image/png" href="image.png?v=1">
<link rel="shortcut icon" href="image.png?v=1">
<style>
  :root{
    --bg:#f7f7fb; --card:#fff; --ink:#0f172a; --muted:#6b7280; --border:#e6e7ec;
    --purple:#4f46e5; --dark:#0c0c14; --danger:#ef4444;
    --content-width:1032px; --logo-size:44px; --card-radius:22px;
    --shadow:0 10px 24px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.08);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:var(--content-width);margin:auto;padding:24px}

  /* Header */
  .header{position:sticky;top:0;background:rgba(255,255,255,.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:2}
  .header .row{max-width:calc(var(--content-width) + 88px);margin:auto;padding:14px 24px;display:flex;align-items:center;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{height:var(--logo-size);width:var(--logo-size);border-radius:12px;background:var(--purple);color:#fff;display:grid;place-items:center;font-weight:800}
  .brand h1{margin:0;font-size:20px}
  .brand small{display:block;color:#6b7280}
  .btn{appearance:none;border:1px solid var(--border);background:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;color:#111;text-decoration:none;font-weight:600}
  .btn:hover{background:#f3f4f6}

  /* Tabs */
  .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;background:#ececef;border-radius:22px;padding:6px}
  .tabs a{display:flex;align-items:center;justify-content:center;gap:8px;padding:12px 16px;min-height:44px;border-radius:18px;color:#111;text-decoration:none;font-weight:700;line-height:1}
  .tabs a:hover{background:#e9e9f2}
  .tabs a.current{background:var(--purple);color:#fff}

  .space{height:24px}

  /* Card */
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--card-radius);box-shadow:var(--shadow);padding:24px}
  .lead{color:#8b92a0;margin:0 0 18px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:14px}
  @media(min-width:760px){ .two{grid-template-columns:1fr 1fr} }

  .status{font-size:12px;padding:6px 10px;border-radius:999px;font-weight:800}
  .s-inprog{background:#eef2ff;color:#3730a3;border:1px solid #c7d2fe}
  .s-pending{background:#fffbeb;color:#92400e;border:1px solid #fde68a}
  .s-done{background:#ecfdf5;color:#065f46;border:1px solid #a7f3d0}

  .k{color:#6b7280;font-weight:700}
  .v{color:#0f172a}

  .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
</style>

<!-- Logout modal styles (same as other PIN pages) -->
<style>
  #logoutModal::backdrop{ background:rgba(2,6,23,.45) }
  #logoutModal{ border:0; padding:0; border-radius:20px; width:min(440px,92%) }
  #logoutModal .lg-card{
    background:#fff; border:1px solid #e5e7eb; border-radius:20px;
    padding:20px; box-shadow:0 24px 48px rgba(2,6,23,.18);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
  }
  #logoutModal h3{ margin:0 0 6px; font-size:20px }
  #logoutModal .lg-text{ margin:0 0 16px; color:#6b7280 }
  #logoutModal .lg-actions{ display:flex; gap:10px; justify-content:flex-end }
  #logoutModal .lg-btn{ padding:12px 16px; border-radius:14px; border:1px solid #e5e7eb; cursor:pointer; background:#fff; font-weight:600 }
  #logoutModal .lg-btn.ghost:hover{ background:#f3f4f6 }
  #logoutModal .lg-btn.danger{ background:#0c0c14; color:#fff; border-color:#0c0c14 }
  #logoutModal .lg-btn.danger:hover{ filter:brightness(1.05) }
</style>
</head>
<body>
  <header class="header">
    <div class="row">
      <div class="brand">
        <div class="logo">P</div>
        <div>
          <h1>Person-In-Need Portal</h1>
          <small id="who">Logged in</small>
        </div>
      </div>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="wrap">
    <nav class="tabs">
      <a href="view-requests.html"><span>üìã</span>View Requests</a>
      <a href="search-requests.html"><span>üîç</span>Search Requests</a>
      <a href="create-request.html"><span>‚ûï</span>Create Request</a>
    </nav>

    <div class="space"></div>

    <section class="card" id="card">
      <div class="lead" id="meta">Loading‚Ä¶</div>
      <h2 id="title" style="margin:0 0 6px"></h2>
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
        <span id="statusBadge" class="status s-pending">Pending</span>
        <span class="muted" id="idLine"></span>
      </div>

      <div class="grid two" style="margin-bottom:12px">
        <div><span class="k">Category</span><div class="v" id="category">‚Äî</div></div>
        <div><span class="k">Date</span><div class="v" id="date">‚Äî</div></div>
        <div><span class="k">Time</span><div class="v" id="time">‚Äî</div></div>
        <div><span class="k">Location</span><div class="v" id="location">‚Äî</div></div>
        <div><span class="k">Views</span><div class="v" id="views">0</div></div>
        <div><span class="k">Shortlisted</span><div class="v" id="shortlist">0</div></div>
      </div>

      <div>
        <span class="k">Description</span>
        <div id="desc" class="v" style="margin-top:6px">‚Äî</div>
      </div>

      <div class="actions">
        <a class="btn" href="view-requests.html">‚Üê Back to My Requests</a>
        <a id="editLink" class="btn" href="#" style="display:none">Edit Request</a>
      </div>

      <div id="error" class="muted" style="display:none;margin-top:12px;color:var(--danger)"></div>
    </section>
  </main>

  <!-- Logout modal -->
  <dialog id="logoutModal" aria-labelledby="logoutTitle">
    <div class="lg-card">
      <h3 id="logoutTitle">Log out?</h3>
      <p class="lg-text">You‚Äôll be returned to the role selection page.</p>
      <div class="lg-actions">
        <button type="button" class="lg-btn ghost" id="lgCancel">Cancel</button>
        <button type="button" class="lg-btn danger" id="lgConfirm">Log out</button>
      </div>
    </div>
  </dialog>

<script>
  const $ = (s,r=document)=>r.querySelector(s);
  const qs = new URLSearchParams(location.search);
  const RID = qs.get('id');

  // highlight current tab
  (function(){
    const current = (location.pathname.split('/').pop() || '');
    document.querySelectorAll('.tabs a').forEach(a=>{
      a.classList.toggle('current', a.getAttribute('href')===current);
    });
  })();

  function fmtDate(d){ try{return new Date((d||'')+'T00:00').toLocaleDateString()}catch(e){return d||'‚Äî'} }
  function statusClass(s){
    const t=(s||'').toLowerCase();
    if(t.includes('progress')) return 'status s-inprog';
    if(t.includes('complete')) return 'status s-done';
    return 'status s-pending';
  }

  async function whoami(){
    const res = await fetch('/api/whoami', {headers:{'Accept':'application/json'}});
    if(!res.ok){ location.href='/'; return; }
    return res.json();
  }

  // Use PIN endpoint shape already supported by Max_app.py
  async function getDetail(id){
    // IMPORTANT: '?inc=1' increments server-side view count exactly once
    const res = await fetch(`/api/requests/${encodeURIComponent(id)}?inc=1`, {headers:{'Accept':'application/json'}});
    if(res.status===401 || res.status===403){ location.href='/'; return; }
    if(!res.ok) throw new Error('HTTP '+res.status);
    return res.json();
  }

  async function render(){
    if(!RID){ location.href='view-requests.html'; return; }

    try{
      const me = await whoami();
      $('#who').textContent = me?.name ? `Logged in as ${me.name}` : 'Logged in';

      const data = await getDetail(RID);
      const r = data.request || {};

      $('#meta').textContent = `Owner: ${r.owner || '‚Äî'}`;
      $('#title').textContent = r.title || 'Untitled';
      $('#idLine').textContent = `#${r.id || ''}`;
      const badge = $('#statusBadge');
      badge.className = statusClass(r.status);
      badge.textContent = r.status || 'Pending';

      $('#category').textContent  = r.category || '‚Äî';
      $('#date').textContent      = fmtDate(r.date);
      $('#time').textContent      = r.time || '‚Äî';
      $('#location').textContent  = r.location || '‚Äî';
      $('#views').textContent     = Number.isFinite(r.viewCount)? r.viewCount : (r.viewCount||0);
      $('#shortlist').textContent = Number.isFinite(r.shortlistCount)? r.shortlistCount : (r.shortlistCount||0);
      $('#desc').textContent      = r.description || '‚Äî';

      // If it's the current user's request, show Edit
      if ((me?.name || me?.username || '') && (r.owner === (me.name||me.username))){
        const edit = $('#editLink');
        edit.href = `update-request.html?id=${encodeURIComponent(r.id)}`;
        edit.style.display = 'inline-block';
      }
    }catch(e){
      console.error(e);
      $('#error').style.display='block';
      $('#error').textContent = 'Unable to load this request.';
    }
  }

  // Logout wiring
  function performLogout(){ fetch('/api/logout', {method:'POST'}).finally(()=>location.href='/'); }
  (function setupLogout(){
    const trigger = $('#logoutBtn');
    const dlg = $('#logoutModal');
    const cancel = $('#lgCancel');
    const confirm = $('#lgConfirm');
    if(!trigger || !dlg) return;
    trigger.addEventListener('click', ()=> dlg.showModal());
    cancel.addEventListener('click', ()=> dlg.close());
    confirm.addEventListener('click', performLogout);
    dlg.addEventListener('click', (e)=>{
      const r = dlg.getBoundingClientRect();
      const inside = e.clientX >= r.left && e.clientX <= r.right && e.clientY >= r.top && e.clientY <= r.bottom;
      if(!inside) dlg.close();
    });
    dlg.addEventListener('close', ()=> trigger.focus());
  })();

  document.addEventListener('DOMContentLoaded', render);
</script>
</body>
</html>
